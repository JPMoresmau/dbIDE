<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/core-signals/core-signals.html">
<link rel="import" href="nav_package.html">
<link rel="import" href="nav_module.html">

<polymer-element name="as-navigator">
  <template>
  	<template id="pkgTemplate">
  			 <as-nav-package pkg="{{model}}">
		      </as-nav-package>
  	</template>
  	<template id="modlTemplate">
  				<as-nav-module modl="{{model}}">
		      </as-nav-module>
  	</template>
  	
  	
		<div vertical style="height:100%">
	  	<core-ajax url="/json/packages" response="{{data}}" handleAs="json" id="ajax"></core-ajax>
	  	<core-signals on-core-signal-selected-package="{{selectedPackage}}"></core-signals>
	  	<paper-input label="Type name prefix" value="{{filt}}" id="prefixFilter"></paper-input>
		  <core-list data="{{data | keyNameStartsWith(filt) | keyNameSort()}}" height="20" style="height:100%" id="list">
		    	<template>
        	<div>
          	<template bind ref="{{data[0]['key']['packagekey']?'modlTemplate':'pkgTemplate'}}">
				    </template>
				   </div>
				   </template>
	 	  </core-list>
		   
    </div>

  </template>
  <script>
	Polymer({
		filt:"",
		data:[],
		ready: function(){
			this.$.ajax.go();
		},
		keyNameStartsWith : function (input, prefix) {
		  if (!input || !prefix){
			  return input;
		  }
			return input.filter(function(item){
		    return item.key.name.toLowerCase().startsWith(prefix.toLowerCase());
		  });
		},
		keyNameSort : function (input){
			if (!input){
				return input;
			}
			return input.sort(function(a,b){
				return a.key.name.localeCompare(b.key.name);
			});
		},
		selectedPackage : function (e, detail, sender){
			var s=JSON.stringify({"key":JSON.stringify(detail)});
			var aj=this.$.ajax;
			aj.abort();
			aj.params=s;
			aj.url="/json/modules";
			this.$.prefixFilter.value="";
			aj.go();
		}
	});
  </script>
</polymer-element>
