<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="file-actions">
  <style>
  paper-dialog {
    width: 200%;
    overflow: auto;
  }

  paper-icon-button.file-button {
     --paper-icon-button: {
        height: 32px;
        width: 32px;
      }
  }

  </style>

  <template>
    <iron-ajax id="creationAjax" handle-as="json" on-response="handleCreation" method="PUT"></iron-ajax>
    <iron-ajax id="deletionAjax" handle-as="json" on-response="handleDeletion" method="DELETE"></iron-ajax>
    <app-toolbar>
      <paper-icon-button id="new_folder" src="/images/folder_new.png" alt="New Folder" on-tap="newFolder" class="file-button"></paper-icon-button>
      <paper-tooltip for="new_folder" offset="0">New Folder</paper-tooltip>
      <paper-icon-button id="new_file" src="/images/file_new.png" alt="New File" on-tap="newFile" class="file-button"></paper-icon-button>
      <paper-tooltip for="new_file" offset="0">New File</paper-tooltip>
      <paper-icon-button id="delete" src="/images/remove.png" alt="Delete" on-tap="deleteFolder" disabled class="file-button"></paper-icon-button>
      <paper-tooltip for="delete" offset="0">Delete Folder</paper-tooltip>
    </app-toolbar>

    <paper-dialog id="new_folder_dialog" on-iron-overlay-closed="folderClosed">
      <h2>New Folder</h2>
      <paper-input id="new_folder_dialog_path" label="Path"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>Accept</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="new_file_dialog" on-iron-overlay-closed="fileClosed">
      <h2>New File</h2>
      <paper-input id="new_file_dialog_path" label="Path"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>Accept</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="delete_folder_dialog" on-iron-overlay-closed="folderDeleteClosed">
      <h2>Delete folder</h2>
      <paper-dialog-scrollable id="delete_folder_text">
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>Accept</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>

    Polymer({

      is: 'file-actions',
      listeners: {
        'path-selected': 'pathSelected',
      },
      selectedPath: null,
      lastCreated: null,
      lastDeleted: null,
      pathSelected: function(e){
        var tgt=e.detail;
        if (this.selectedPath){
          Polymer.dom(this.selectedPath).classList.remove("dir-selected");
        }
        this.selectedPath=tgt;
        Polymer.dom(tgt).classList.add("dir-selected");
        this.$.delete.disabled=this.selectedPath==null;
      },
      selectedPathName : function(add){
        if (!this.selectedPath){
          return "";
        } else {
          if (add){
            return this.selectedPath.parentNode.path+"/";
          }
          return this.selectedPath.parentNode.path;
        }
      },
      newFile: function(){
        this.$.new_file_dialog_path.value=this.selectedPathName(true);
        this.$.new_file_dialog.open();
      },
      newFolder: function(){
        this.$.new_folder_dialog_path.value=this.selectedPathName(true);
        this.$.new_folder_dialog.open();
      },
      deleteFolder: function(){
        Polymer.dom(this.$.delete_folder_text).innerHTML="Are you sure you want to delete "+this.selectedPathName(false)+"?";
        this.$.delete_folder_dialog.open();
      },
      fileClosed: function(e){
        if (e.detail.confirmed){
          var p=this.$.new_file_dialog_path.value;
          var aj=this.$.creationAjax;
          aj.url="/file/"+p;
          aj.body="";
          aj.generateRequest();
          this.lastCreated=p;
        }
      },
      folderClosed: function(e){
        if (e.detail.confirmed){
          var p=this.$.new_folder_dialog_path.value;
          var aj=this.$.creationAjax;
          aj.url="/files/"+p;
          aj.generateRequest();
          this.lastCreated=p;
        }
      },
      folderDeleteClosed: function(e){
        if (e.detail.confirmed){
          var aj=this.$.deletionAjax;
          var p=this.selectedPathName(false);
          aj.url="/files/"+p;
          aj.generateRequest();
          this.lastDeleted=p;
        }
      },
      handleCreation: function(e){
        if (e.detail.status==201){
          this.fire("file-system-changed",{"created":this.lastCreated});
        }
      },
      handleDeletion: function(e){
        if (e.detail.status==200){
          this.fire("file-system-changed",{"delete":this.lastDeleted});
        }
      }
    });
  </script>

</dom-module>
