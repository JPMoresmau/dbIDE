<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/juicy-ace-editor/juicy-ace-editor.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="file-editor">
  <style>

  :host {
    display: block;
    padding: 10px;
  }
  .card {
    box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
    padding: 8px;
    margin: 12px;
    border-radius: 5px;
    background-color: #fff;
    color: #757575;
    position:absolute;
    bottom: 0px;
    top: 60px;
    right: 0px;
    left: 0px;
  }

  juicy-ace-editor {
    position:absolute;
    bottom: 10px;
    top: 10px;
    right: 10px;
    left: 10px;
    display: none;
  }
  </style>

  <template>
    <iron-ajax id="ajax" url="/file/{{path}}" handle-as="text" on-response="handleResponse"></iron-ajax>
    <iron-ajax id="ajaxPut" url="/file/{{path}}" handle-as="text" method="PUT"></iron-ajax>
    <div class="card">
        <juicy-ace-editor id="editor" mode$="{{mode}}" softtabs="true" tabsize="2" on-change="textChange">
        </juicy-ace-editor>
    </div>
  </template>

  <script>
  Polymer({
    is: 'file-editor',
    mode: "",
    properties: {
      'path': {
        type: String,
        observer: "pathChanged"
      },
      'mime': {
        type: String,
        observer: "mimeChanged"
      }
    },
    pathChanged: function(){
      this.unlisten(this.$.editor, 'change', 'textChange');
      this.$.editor.onChange=function(e){};
      this.$.editor.value="";
      if (this.path){
        this.$.ajax.generateRequest();
        this.$.editor.style.display='block';
      } else {
        this.$.editor.style.display='none';
      }

    },
    mimeChanged: function(){
      this.mode="ace/mode/text";
      var mode=this.mime;
      if (mode.indexOf("haskell")>-1){
        mode="ace/mode/haskell";
      } else if (mode.indexOf("yaml")>-1){
        mode="ace/mode/yaml";
      } else if (mode.indexOf("json")>-1){
        mode="ace/mode/json";
      } else if (this.path && this.path.endsWith(".md")>-1){
        mode="ace/mode/markdown";
      }
      this.mode=mode;
    },
    handleResponse: function(e){
      var ed=this.$.editor;
      ed.value=e.detail.response;
      ed.editor.clearSelection( );
      ed.editor.moveCursorTo(0,0);
      ed.editor.focus();
      this.listen(this.$.editor, 'change', 'textChange');
    },
    textChange: function(e){
      console.log(e.detail);
      var ed=this.$.editor;
      this.$.ajaxPut.body=ed.value;
      this.$.ajaxPut.generateRequest();
    },
    fileOpened: function(e){
      if (e && e.detail){
        this.path=e.detail.path;
        this.mime=e.detail.mime;
      } else {
        this.path=null;
        this.mime="text/plain";
      }

    }
  });
  </script>
</dom-module>
